rendering and editing in peregrine
===

Single Page Applications are commonly developed with a set of components that are stitched together into 
an application at compile time. For a larger application (in the case of peregrine-cms the admin UI) or
for a website built with the PWA/SPA concepts it may however not be desirable to work at compile time. 
Peregrine-cms hence introduces a concept of a page structure to assemble the components for a page and
render the corresponding page. 

# Rendering

Rendering is driven straight out of a json response representing a page: 

in a default peregrine-cms installation a request to http://localhost:8080/content/sites/example.html
will subsequently trigger a request to http://localhost:8080/content/sites/example.data.json . This
fetches a `json` structure that is used to render the page

```json
{
  "children": [
    {
      "brand": "example",
      "navigation": [
        {
          "path": "/content/sites/example/about",
          "title": "about",
          "fromTemplate": true
        },
        {
          "path": "/content/sites/example/contact",
          "title": "contact",
          "fromTemplate": true
        },
        {
          "path": "/content/sites/example/services",
          "title": "services",
          "fromTemplate": true
        }
      ],
      "path": "/jcr:content/nav",
      "component": "example-components-nav",
      "fromTemplate": true
    },
    {
      "collection": null,
      "path": "/jcr:content/footer",
      "component": "example-components-footer",
      "jcr:primaryType": "nt:unstructured",
      "sling:resourceType": "example/components/footer",
      "fromTemplate": true
    },
    {
      "title": "hello",
      "text": "world",
      "path": "/jcr:content/jumbotron",
      "component": "example-components-jumbotron"
    },
    {
      "children": [
        {
          "children": [
            {
              "children": [
                {
                  "text": "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed facilisis sem fringilla, commodo erat id, ultricies orci. Etiam sit amet eleifend ipsum. Phasellus vitae purus metus. Sed et eros enim. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Phasellus in ullamcorper augue. Aenean accumsan dictum nibh non sollicitudin. Integer venenatis nisi in nulla posuere, vitae congue sem lacinia. Sed vulputate feugiat quam, dapibus condimentum diam congue id. Sed condimentum metus mauris, vitae ultricies leo rutrum a. Ut cursus a nisi id tincidunt. Mauris dui enim, vehicula eget ante sit amet, pretium elementum orci. In hac habitasse platea dictumst. Nunc faucibus nibh vitae placerat feugiat. Nulla ac maximus sem. Duis ullamcorper lacinia erat, sollicitudin blandit nisl tempor at.",
                  "path": "/jcr:content/content/row/col1/text1",
                  "component": "example-components-text"
                }
              ],
              "classes": "col-md-12",
              "path": "/jcr:content/content/row/col1",
              "component": "example-components-col"
            }
          ],
          "path": "/jcr:content/content/row",
          "component": "example-components-row"
        }
      ],
      "path": "/jcr:content/content",
      "component": "example-components-container"
    }
  ],
  "component": "example-components-page",
  "dataDefault": null,
  "dataFrom": null,
  "description": "this is an example site",
  "domains": null,
  "experiences": null,
  "fromTemplate": true,
  "loaders": null,
  "pagePath": "/content/sites/example",
  "path": "/jcr:content",
  "siteCSS": [
    "/etc/felibs/pagerender-vue/bootstrap/css/bootstrap.min.css"
  ],
  "siteJS": [
    "/etc/felibs/pagerender-vue/jquery/jquery.slim.min.js",
    "https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js",
    "/etc/felibs/pagerender-vue/bootstrap/js/bootstrap.min.js"
  ],
  "siteRoot": "/content/sites/example",
  "suffixToParameter": null,
  "tags": null,
  "template": "/content/templates/example",
  "title": "example vuejs site"
}
```

## individual component structure

the following is a boiler plate structure of any component

```json
{
    "children": [],
    "path": "/jcr:content/content",
    "component": "example-components-container",
    "fromTemplate": true
}
```

`children` is optional and lists all the children of this component, `fromTemplate` only exists if the
component is not managed by this page and was generated by a template structure. (see documentation on
hoe peregrine handles templates for pages for more details)

### loaders, suffixes

Peregrine uses the same json structure it uses to define pages to render the admin console. In fact, peregrine 
itself is really just a framework to build applications. The admin console as well as a web page is just
an application. The root of a page can have a section called `loaders`. We use this to trigger front end
javascript methods with a parameter from the store. 

Peregrine also uses suffixes extensively throughout the admin console. We use the apache sling definition 
of a suffix - the following is how peregrine looks at an url:

`protocol://server:port/path[.selector]*.ext/suffix`

the suffix part is used to drive parameters into the application and avoid GET parameters. A page
can have a `suffixToParameter` section at the root defining where a suffix passed in the url should 
be stored in the store of the application. 

```json
{
  "suffixToParameter": [
    "path",
    "/state/tools/pages"
  ],
  "loaders": [
    "populateNodesForBrowser:/state/tools/pages"
  ]
}
```

the above example does two things: we first store a suffix called `path` into our store at `/state/tools/pages`
and then we use a loader called `populateNodesForBrowser` with the data from `/state/tools/pages`. This
example is taken from http://localhost:8080/content/admin/pages.html - the page navigation section of the 
admin ui. 

## rendering engines

peregrine aims to be render engine agnostic. As long as a render engine can handle the json data for a page
and output a rendered site we're good to go. 

currently peregrine supports the following render engines out of the box: 

- vuejs
- react
- server side apache slinig rendering



# Editing

the peregrine-cms editing UI uses a set of data attributes on html elements to correlate the page model
with the rendered html. We chose this simple approach to have the least amount of coupling between the 
editor and the actual page. This also allows to bring in future rendering engines with ease as the 
api between rendered page and editor is simple and well defined. 

Currently we use the following `data-per` attribute:

- `data-per-path`: defines the relative path of the node in the model

We also add the following attributes to drop areas like `container start` and `container end` to control
the drop action better (note: these helpers are only rendered when a page is being edited in the admin
interface)

- `data-per-droptraget`: value: `true`
- `data-per-location`: value: `before` or `after` (controls if the drop action inserts at the beginning 
   or at the end of a list)

The editor console uses a html iframe element to render the editable page and an overlay on top of the 
iframe to render all decorations. 

If a page is rendered in the editor interface we also add an `iframe` to end of the page with the 
id `height_change_listener`. This is used to sync the scrollbar and the editing overlay height. 